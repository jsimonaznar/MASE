close all; 

% First we download a list of ALL spk kernels, if it is not
% available

if ~isfile('JunoAll.mat')
    close all; 

clear; 

% Load kernels.
METAKR= { 'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/lsk/naif0012.tls', ... %Leap seconds
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/lsk/naif0011.tls',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/lsk/naif0009.tls',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/lsk/naif0010.tls',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/planets/de430.bsp',... %Planetary ephemeris
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/pck00011.tpc',... %Planet radii and orientation
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/de-403-masses.tpc',... %Masses of planets
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/pck00010.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/MARS2020/kernels/pck/pck00010.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/pck00011_n0066.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/gm_de431.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/gm_de440.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/Gravity.tpc',... %Gravity kernel
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_110805_111026_120302.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_111026_120308_120726.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_120308_120825_121109.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_120825_130515_130708.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_130515_131005_131031.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_130515_131005_151210.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_131005_131014_131101.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_131005_131014_131101_reconstruction.bsp.lbl',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_131014_131114_140222.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_131114_140918_141208.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_131114_140918_141208_reconstruction.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_140903_151003_160118.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_151003_160312_160418.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_160312_160522_160614.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_160522_160729_160909.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_160729_160923_161027.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_160729_160924_161026_pj01.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_160923_161115_161121.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_161115_170106_170113.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_170106_170228_170307.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_170228_170422_170427.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_170422_170608_170621.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_170608_170728_170803.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_170728_170918_170922.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_170918_171121_171127.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_171121_180113_180117.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_180113_180307_180312.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_180307_180429_180504.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_180429_180621_180626.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_180620_180812_180821.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_180812_181004_181011.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_181004_181126_181205.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_181126_190118_190124.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_190118_190312_190319.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_190312_190504_190509.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_190504_190626_190627.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_190626_190817_190822.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_190817_191010_191022.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_191010_191201_191210.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_191201_200124_200129.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_200124_200316_200324.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_200316_200508_200512.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_200508_200629_200709.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_200629_200822_200826.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_200822_201014_201016.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_201014_201205_201208.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_201205_210127_210210.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_210127_210321_210329.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_210321_210513_210517.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_210513_210630_210707.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_210630_210813_210825.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_210813_210925_211005.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_210925_211108_211115.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_211108_211222_220104.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_211222_220204_220210.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_220204_220319_220330.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_220319_220502_220510.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_220502_220614_220622.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_220614_220728_220805.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_220728_220909_220913.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_220909_221019_221027.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_221019_221127_221208.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_221127_230104_230111.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230104_230211_230221.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230211_230321_230327.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230321_230428_230504.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230428_230605_230613.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230605_230713_230720.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230713_230820_230823.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/spk/spk_rec_230820_230927_231003.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v12.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/planets/de441_part-1.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/planets/de441_part-2.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/mars_iau2000_v1.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/fk/planets/earth_assoc_itrf93.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/MARS2020/kernels/spk/de430s.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/MARS2020/kernels/spk/de438s.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/MARS2020/kernels/spk/mar097.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/MARS2020/kernels/spk/mar097s.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v01.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v02.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v07.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v08.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v09.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v10.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v11.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v12.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/pck/pck00008.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/pck/pck00009.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/pck/pck00010.tpc',...
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/satellites/jup344.cmt', ... %Jupiter moons kernel
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/satellites/jup346.cmt', ... %Jupiter kernel
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/lsk/naif0012.tls', ... %Leap seconds
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/planets/de430.bsp',... %Planetary ephemeris
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/pck00011.tpc',... %Planet radii and orientation
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/de-403-masses.tpc',... %Masses of planets
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/moon_pa_de403_1950-2198.bpc',... %Masses of moons
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/pck/Gravity.tpc',... %Gravity kernel
        'https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/satellites/jup365.bsp',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/fk/juno_v12.tf',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/ck/juno_sa_nom_110801_171101_v01.bc',...
        'https://naif.jpl.nasa.gov/pub/naif/JUNO/kernels/sclk/JNO_SCLKSCET.00158.tsc'};

    save('JunoAll.mat','METAKR');
else % otherwise, load it
    load('JunoAll.mat');
end


% Add additional kernels also needed

METAKR{end+1}='https://naif.jpl.nasa.gov/pub/naif/generic_kernels/lsk/naif0012.tls';


for i=1:numel(METAKR)
    fprintf('\"%s\", \n',METAKR{i});
end


initSPICEv(fullK(METAKR)); % fullK forms the full list needed by initSPICEv

 
%% 1-plot all the trajectory available of these bodies respect to observer
if 1
    figure(1);
    OB={'JUNO','JUPITER', 'EARTH', 'SUN'}; %'IO','EUROPA','CALLISTO','GANYMEDE'};
      %'cejsvtio'
    co='rgby';

    frame = 'ECLIPJ2000';
    abcorr = 'NONE';
    observer='SUN';
    au = 1; % km
    et = cspice_str2et( { '2011 AUG 05 17:34:00 TDB',                ...
                      '2013 APR 14 14:55:00 TDB'} );
    cnfine = cspice_wninsd( et(1), et(2) );

    for b=1:numel(OB)
        sc=OB{b};
        for i=1:2:numel(cnfine)
            fprintf('<%s> and <%s> From %s to %s \n',sc,observer,cspice_et2utc(et(1),'C',1),cspice_et2utc(et(2),'C',1));
            e_t = linspace(cnfine(i),cnfine(i+1),100000);
            [d,lt] = cspice_spkezr(sc,e_t,frame,abcorr,observer);
            if sc == "JUNO"
                % Plot a point where is the Earth in the last date          
                plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 5);            
                hold on
                plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)), 'LineWidth', 3 );
            end
            if sc == "JUPITER"
                % Plot a point where is the Earth in the last date          
                plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 15);            
                hold on
                plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)), 'LineWidth', 2 );
            end
            if sc == "EARTH"
                % Plot a point where is the Earth in the last date          
                plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 10);            
                hold on
                plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)), 'LineWidth', 2 );
            end
            if sc == "SUN"
                % Plot a point where is the Earth in the last date          
                plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 20);            
                hold on
                plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)), 'LineWidth', 2 );
            end
            %if sc == "IO"
            %    % Plot a point where is the Earth in the last date          
            %    plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 2);            
            %    hold on
            %    plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)) );
            %end
            %if sc == "EUROPA"
            %    % Plot a point where is the Earth in the last date          
            %    plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 2);            
            %    hold on
            %    plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)) );
            %end
            %if sc == "CALLISTO"
            %    % Plot a point where is the Earth in the last date          
            %    plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 2);            
            %    hold on
            %    plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)) );
            %end
            %if sc == "GANYMEDE"
            %    % Plot a point where is the Earth in the last date          
            %    plot3(d(1,end)./au,d(2,end)./au,d(3,end)./au, strcat(co(b), 'o-'), 'MarkerFaceColor', co(b), 'MarkerSize', 2);            
            %    hold on
            %    plot3(d(1,:)./au,d(2,:)./au,d(3,:)./au, strcat('-',co(b)) );
            %    hold off
            %end
            
            set(gcf, 'color', 'k'); % 'k' for black background, 'none' for no color
            set(gca, 'color', 'k');
            set(gca, 'xcolor', 'white');
            set(gca, 'ycolor', 'white');
            set(gca, 'zcolor', 'white');
        end
    end
end
%
%%% 2-plot the distance between Cassini and Saturn in all the available range
%if 1
%    figure(2);
%    sr=58300; % km, mean(radii)
%    tw1  =coverageKernels('SPK','CASSINI');         
%    tw2  =coverageKernels('SPK','SATURN');         
%    twi =cspice_wnintd(tw1,tw2); % intersection of both
%    frame = 'ECLIPJ2000';
%    abcorr = 'NONE';
%    observer='SUN';
%    for i=1:2:numel(twi)
%        et=linspace(twi(i),twi(i+1),8000);
%        [d1,lt]=cspice_spkezr('CASSINI',et,frame,abcorr,observer);
%        [d2,lt]=cspice_spkezr('SATURN',et,frame,abcorr,observer);
%        d=d1-d2;
%        d=d(1:3,:);
%        nd=vecnorm(d);
%        semilogy(et,nd/sr);
%        hold on
%        mm=min(nd);
%        if i==1
%           Gmin=mm;
%        else
%           Gmin=min([Gmin mm]);
%        end
%    end
%    fprintf('Minimum Saturn - Cassini distance Gmin=%e in Saturn Radius (%e km)\n',Gmin/sr,sr);
%end